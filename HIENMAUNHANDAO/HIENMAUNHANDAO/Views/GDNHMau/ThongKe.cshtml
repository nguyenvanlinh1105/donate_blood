@{
    Layout = "Layout_GDNH";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="~/css/gdnh/thongke.css" />
<section class="report-section" style="padding: 50px 0; background-color: #f8f9fa;">
    <div class="container">
        <div class="row">
            <!-- Báo cáo chi tiết -->
            <div class="col-lg-8 col-md-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h2 class="mb-0"><i class="fas fa-tint me-2"></i>BÁO CÁO THÔNG TIN MÁU CHI TIẾT</h2>
                    </div>
                    <div class="card-body">
                        <!-- Bộ lọc nâng cao -->
                        <div class="advanced-filters mb-4">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="bloodGroupFilter" class="form-label">Nhóm máu</label>
                                    <select class="form-select" id="bloodGroupFilter">
                                        <option value="">Tất cả</option>
                                        <option value="A">Nhóm A</option>
                                        <option value="B">Nhóm B</option>
                                        <option value="AB">Nhóm AB</option>
                                        <option value="O">Nhóm O</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="statusFilter" class="form-label">Tình trạng</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">Tất cả</option>
                                        <option value="Sẵn sàng">Sẵn sàng</option>
                                        <option value="Đã sử dụng">Đã sử dụng</option>
                                        <option value="Hết hạn">Hết hạn</option>
                                        <option value="Đang kiểm tra">Đang kiểm tra</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="dateFromFilter" class="form-label">Từ ngày</label>
                                    <input type="text" class="form-control" id="dateFromFilter">
                                </div>
                                <div class="col-md-3">
                                    <label for="dateToFilter" class="form-label">Đến ngày</label>
                                    <input type="text" class="form-control" id="dateToFilter">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="sourceFilter" class="form-label">Nguồn hiến</label>
                                    <select class="form-select" id="sourceFilter">
                                        <option value="">Tất cả nguồn</option>
                                        <option value="Trường ĐH Sư phạm Kỹ thuật">Trường ĐH Sư phạm Kỹ thuật</option>
                                        <option value="UBND Thanh Bình">UBND Thanh Bình</option>
                                        <option value="Trung Tâm Hiến Máu">Trung Tâm Hiến Máu</option>
                                        <option value="Bệnh viện Truyền máu">Bệnh viện Truyền máu</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="volumeFilter" class="form-label">Số lượng (ml)</label>
                                    <select class="form-select" id="volumeFilter">
                                        <option value="">Tất cả</option>
                                        <option value="<250">Dưới 250ml</option>
                                        <option value="250-350">250-350ml</option>
                                        <option value=">350">Trên 350ml</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <button id="resetFilters" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-undo"></i> Đặt lại
                                </button>
                                <button id="applyFilters" class="btn btn-danger">
                                    <i class="fas fa-filter"></i> Áp dụng
                                </button>
                            </div>
                        </div>

                        <!-- Bảng dữ liệu nâng cao -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead class="table-danger">
                                    <tr>
                                        <th style="width: 5%">STT</th>
                                        <th style="width: 10%">Mã đơn vị</th>
                                        <th style="width: 10%">Nhóm máu</th>
                                        <th style="width: 10%">Rh</th>
                                        <th style="width: 10%">Số lượng (ml)</th>
                                        <th style="width: 15%">Ngày hiến</th>
                                        <th style="width: 15%">Hạn sử dụng</th>
                                        <th style="width: 15%">Nguồn hiến</th>
                                        <th style="width: 10%">Tình trạng</th>
                                    </tr>
                                </thead>
                                <tbody id="bloodTableBody"></tbody>
                            </table>
                        </div>

                        <!-- Phân trang và xuất báo cáo -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="dataTables-info" id="dataTableInfo">Hiển thị 0 đến 0 của 0 bản ghi</div>
                            <nav aria-label="Page navigation">
                                <ul class="pagination" id="pagination"></ul>
                            </nav>
                            <div class="export-buttons">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-download me-1"></i> Xuất báo cáo
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" id="exportPDF"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                                        <li><a class="dropdown-item" href="#" id="exportExcel"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                                        <li><a class="dropdown-item" href="#" id="exportCSV"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
                                        <li><a class="dropdown-item" href="#" id="exportPrint"><i class="fas fa-print me-2"></i>In báo cáo</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biểu đồ xu hướng theo thời gian -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="fas fa-chart-line me-2"></i>XU HƯỚNG HIẾN MÁU THEO THỜI GIAN</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 420px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-period="week">Tuần</button>
                                <button type="button" class="btn btn-outline-primary" data-period="month">Tháng</button>
                                <button type="button" class="btn btn-outline-primary" data-period="quarter">Quý</button>
                                <button type="button" class="btn btn-outline-primary" data-period="year">Năm</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thống kê và báo cáo tổng quan -->
            <div class="col-lg-4 col-md-12">
                <!-- Thống kê tổng quan -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0"><i class="fas fa-chart-pie me-2"></i>THỐNG KÊ TỔNG QUAN</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="stat-card bg-light-danger p-3 rounded text-center">
                                    <h5 class="text-danger">Tổng đơn vị máu</h5>
                                    <h2 class="mb-0" id="totalUnits">0</h2>
                                    <small class="text-muted">đơn vị</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-card bg-light-primary p-3 rounded text-center">
                                    <h5 class="text-primary">Tổng lượng máu</h5>
                                    <h2 class="mb-0" id="totalVolume">0</h2>
                                    <small class="text-muted">ml</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-card bg-light-warning p-3 rounded text-center">
                                    <h5 class="text-warning">Sẵn sàng</h5>
                                    <h2 class="mb-0" id="readyUnits">0</h2>
                                    <small class="text-muted">đơn vị</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-card bg-light-info p-3 rounded text-center">
                                    <h5 class="text-info">Đã sử dụng</h5>
                                    <h2 class="mb-0" id="usedUnits">0</h2>
                                    <small class="text-muted">đơn vị</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phân bổ nhóm máu -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="mb-0"><i class="fas fa-chart-bar me-2"></i>PHÂN BỔ NHÓM MÁU</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="bloodGroupChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Nhóm máu</th>
                                        <th>Số lượng</th>
                                        <th>Tỷ lệ</th>
                                    </tr>
                                </thead>
                                <tbody id="bloodGroupStats">
                                    <tr>
                                        <td>A</td>
                                        <td id="groupA">0</td>
                                        <td id="groupAPercent">0%</td>
                                    </tr>
                                    <tr>
                                        <td>B</td>
                                        <td id="groupB">0</td>
                                        <td id="groupBPercent">0%</td>
                                    </tr>
                                    <tr>
                                        <td>AB</td>
                                        <td id="groupAB">0</td>
                                        <td id="groupABPercent">0%</td>
                                    </tr>
                                    <tr>
                                        <td>O</td>
                                        <td id="groupO">0</td>
                                        <td id="groupOPercent">0%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Phân bổ theo nguồn hiến -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-white">
                        <h3 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>PHÂN BỔ THEO NGUỒN HIẾN</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="sourceDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Cảnh báo lượng máu thấp -->
                <div class="card shadow-sm border-danger">
                    <div class="card-header bg-danger text-white">
                        <h3 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>CẢNH BÁO LƯỢNG MÁU THẤP</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3">
                            <h5 class="alert-heading"><i class="fas fa-tint me-2"></i>Nhóm AB</h5>
                            <p class="mb-1">Chỉ còn <strong>2 đơn vị</strong> sẵn sàng</p>
                            <small class="text-muted">Dự kiến hết trong 3 ngày</small>
                        </div>
                        <div class="alert alert-danger">
                            <h5 class="alert-heading"><i class="fas fa-tint me-2"></i>Nhóm O-</h5>
                            <p class="mb-1">Chỉ còn <strong>1 đơn vị</strong> sẵn sàng</p>
                            <small class="text-muted">Cần bổ sung gấp</small>
                        </div>
                        <button class="btn btn-outline-danger w-100">
                            <i class="fas fa-bell me-2"></i>Thiết lập cảnh báo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>




<script>
        // =================== DỮ LIỆU GIẢ ===================
        const bloodData = [
            { id: 1, code: "M001", group: "A", rh: "+", volume: 350, date: "2025-05-01", expiry: "2025-07-01", source: "Trường ĐH Sư phạm Kỹ thuật", status: "Sẵn sàng" },
            { id: 2, code: "M002", group: "O", rh: "-", volume: 250, date: "2025-05-10", expiry: "2025-07-10", source: "Trung Tâm Hiến Máu", status: "Đã sử dụng" },
            { id: 3, code: "M003", group: "AB", rh: "+", volume: 300, date: "2025-05-15", expiry: "2025-07-15", source: "UBND Thanh Bình", status: "Sẵn sàng" }
        ];

        // =================== CẬP NHẬT BẢNG ===================
        function renderTable(data) {
            const tbody = $("#bloodTableBody");
            tbody.empty();
            data.forEach((item, index) => {
                tbody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.code}</td>
                        <td>${item.group}</td>
                        <td>${item.rh}</td>
                        <td>${item.volume}</td>
                        <td>${item.date}</td>
                        <td>${item.expiry}</td>
                        <td>${item.source}</td>
                        <td>${item.status}</td>
                    </tr>
                `);
            });
            $("#dataTableInfo").text(`Hiển thị 1 đến ${data.length} của ${data.length} bản ghi`);
        }

        // =================== THỐNG KÊ TỔNG QUAN ===================
        function updateStats(data) {
            const totalUnits = data.length;
            const totalVolume = data.reduce((sum, d) => sum + d.volume, 0);
            const readyUnits = data.filter(d => d.status === "Sẵn sàng").length;
            const usedUnits = data.filter(d => d.status === "Đã sử dụng").length;

            $("#totalUnits").text(totalUnits);
            $("#totalVolume").text(totalVolume);
            $("#readyUnits").text(readyUnits);
            $("#usedUnits").text(usedUnits);
        }

        // =================== BIỂU ĐỒ NHÓM MÁU ===================
        function updateBloodGroupStats(data) {
            const groupStats = { A: 0, B: 0, AB: 0, O: 0 };
            data.forEach(d => { if (groupStats[d.group] !== undefined) groupStats[d.group]++; });

            const total = data.length;
            for (let g in groupStats) {
                $(`#group${g}`).text(groupStats[g]);
                $(`#group${g}Percent`).text(total ? `${Math.round((groupStats[g] / total) * 100)}%` : "0%");
            }

            new Chart(document.getElementById("bloodGroupChart"), {
                type: "doughnut",
                data: {
                    labels: ["A", "B", "AB", "O"],
                    datasets: [{
                        data: [groupStats.A, groupStats.B, groupStats.AB, groupStats.O],
                        backgroundColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0"]
                    }]
                },
                options: { responsive: true }
            });
        }

        // =================== BIỂU ĐỒ XU HƯỚNG ===================
        function renderTrendChart() {
            const labels = ["Tuần 1", "Tuần 2", "Tuần 3", "Tuần 4"];
            const donations = [5, 12, 8, 15];

            new Chart(document.getElementById("trendChart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Số đơn vị hiến máu",
                        data: donations,
                        borderColor: "#007bff",
                        backgroundColor: "rgba(0, 123, 255, 0.1)",
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: "#007bff"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Đơn vị máu' } },
                        x: { title: { display: true, text: 'Thời gian' } }
                    }
                }
            });
        }

        // =================== BIỂU ĐỒ NGUỒN HIẾN ===================
        function renderSourceDistributionChart() {
            const sources = [
                "Trường ĐH Sư phạm Kỹ thuật",
                "UBND Thanh Bình",
                "Trung Tâm Hiến Máu",
                "Bệnh viện Truyền máu"
            ];
            const counts = [10, 7, 14, 5];

            new Chart(document.getElementById("sourceDistributionChart"), {
                type: "bar",
                data: {
                    labels: sources,
                    datasets: [{
                        label: "Số lượng hiến",
                        data: counts,
                        backgroundColor: [
                            "#e74c3c",
                            "#3498db",
                            "#f1c40f",
                            "#2ecc71"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Đơn vị máu' } },
                        x: { title: { display: true, text: 'Nguồn hiến máu' } }
                    }
                }
            });
        }

        // =================== KHỞI TẠO ===================
        $(document).ready(function () {
            renderTable(bloodData);
            updateStats(bloodData);
            updateBloodGroupStats(bloodData);
            renderTrendChart();
            renderSourceDistributionChart();

            $("#applyFilters").click(() => {
                alert("Áp dụng lọc chưa được hiện thực!");
            });

            $("#resetFilters").click(() => {
                renderTable(bloodData);
                updateStats(bloodData);
                updateBloodGroupStats(bloodData);
            });
        });

        let trendChartInstance = null;

    const trendData = {
        week: {
            labels: ["Tuần 1", "Tuần 2", "Tuần 3", "Tuần 4"],
            data: [5, 12, 8, 15]
        },
        month: {
            labels: ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6"],
            data: [25, 30, 22, 18, 35, 28]
        },
        quarter: {
            labels: ["Quý 1", "Quý 2", "Quý 3", "Quý 4"],
            data: [70, 85, 60, 90]
        },
        year: {
            labels: ["2020", "2021", "2022", "2023", "2024"],
            data: [220, 260, 310, 400, 380]
        }
    };

    function renderTrendChart(period = "week") {
        const ctx = document.getElementById("trendChart").getContext("2d");

        if (trendChartInstance) {
            trendChartInstance.destroy();
        }

        const { labels, data } = trendData[period];

        trendChartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Số đơn vị hiến máu",
                    data: data,
                    borderColor: "#007bff",
                    backgroundColor: "rgba(0, 123, 255, 0.1)",
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: "#007bff"
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Đơn vị máu' } },
                    x: { title: { display: true, text: 'Thời gian' } }
                }
            }
        });
    }


    $(".btn-group-sm .btn").click(function () {
        $(".btn-group-sm .btn").removeClass("active");
        $(this).addClass("active");

        const period = $(this).data("period");
        renderTrendChart(period);
    });
</script>